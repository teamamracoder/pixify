{% extends "enduser/base.html" %}

{% block title %}Pixify-Home{% endblock %}


{% block content %}
{%load static %}
{% load humanize %}
<style>
    #dp {
       position: absolute;
       left: 7%;
       /* margin-top: -150px;   */
       border: 3px solid #4f0cb4e3;
       height: 40px;
       width: 40px;
       border-radius: 50%;
       overflow: hidden;
       background: relative;
   }

    #dp img {
       width: 100%;
       height: 100%;
       object-fit: cover;
       object-position: center;

   }

   </style>
<div class="px-3 py-3 mt-3" id="homepage">
    <!-- story short view -->
<!-- story short view -->
<div class="stories-container">
    <div class="content">
        <div class="previous-btn active1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
            </svg>
        </div>

        <div class="stories">

            <div class="mx-1 bg- rounded story" onclick="uploadStory()" type="button" style="width: 120px; height: 180px;background-color: #bf16e0e3">
                {% comment %} {% if story_dict.story.posted_by.profile_photo_url.0 %}
                <img src="{% static storys.posted_by.profile_photo_url.0 %}" alt="" class="card-img-top" style="min-height: 105px; object-fit: cover;">
                   {% else %}
                  <img src="{% static 'images/avatar.jpg' %}" alt="Default Profile" class="card-img-top" style="min-height: 105px; object-fit: cover;">
           {% endif %} {% endcomment %}
                <img src="{% static 'images/avatar.jpg' %}" alt="Default Profile" id="StorysectionUserProfile" class="card-img-top" style="min-height: 105px; object-fit: cover;">
                <div class="d-flex align-items-center justify-content-center position-relative" style="min-height: 65px; background: relative;">
                    <p class="mb-0 text-center fs-7 fw-bold" style="color: white; position: relative;">Create story</p>
                    <div class="position-absolute top-0 start-50 translate-middle plus-btn">
                        <i class="fas fa-plus-circle fs-3 text-primary bg-white p-1 rounded-circle"></i>
                    </div>
                </div>
            </div>


    {% for story in story_dict.storys %}
       {% if story.content_type != 1 %}

    <div class="story" style="border: 2px solid #fff;" onclick="openStoryView('{{ story.posted_by.id }}', '{{ forloop.counter0 }}')">
        <div class="authorrr">{{ story.posted_by.first_name }}      {{ story.posted_by.last_name }}</div>


        {% if story.content_type == 3 and story.media_url.0 %}
            <video controls>
                <source src="{% static story.media_url.0 %}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        {% elif story.content_type == 2 and story.media_url.0 %}
            <img src="{% static story.media_url.0 %}" alt="Story Image">

        {% else %}
            <p>No media or text available.</p>
        {% endif %}
        <div id="dp">
            {% if story.posted_by.profile_photo_url %}
            <img src="{% static story.posted_by.profile_photo_url %}" alt="">
               {% else %}
              <img src="{% static 'images/avatar.jpg' %}" alt="Default Profile">
       {% endif %}
        </div>
    </div>

    {% else %}
    <div class="story txtStory" onclick="openStoryView('{{ story.posted_by.id }}', '{{ forloop.counter0 }}')">
        <div class="authorrr">{{ story.posted_by.first_name }}      {{ story.posted_by.last_name }}</div>
        {% if story.description %}
            <p class="story-text"style="margin:10px;">{{ story.description }}</p>
        {% else %}
            <p>No media or text available.</p>
        {% endif %}
        <div id="dp">
            {% if story.posted_by.profile_photo_url %}
            <img src="{% static story.posted_by.profile_photo_url %}" alt="">
               {% else %}
              <img src="{% static 'images/avatar.jpg' %}" alt="Default Profile">
            {% endif %}
        </div>
    </div>

    {% endif %}
{% endfor %}


        </div>

        <div class="next-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
        </div>
    </div>
</div>

<!-- stories-full-view -->

<div class="container-fluid stories-full-view" id="story-view" style="display: none;">
    <div class="story-section" id="storySection">
        <div class="top-bar d-flex justify-content-between align-items-center">
            <div class="profile-info d-flex align-items-center">
                <div class="profile-img">
                    <img src="static/images/" alt="Profile">
                </div>
                <span class="username" id="usernamecr"></span>
            </div>
            <div class="close-icon" id="closeIcon">&times;</div>
        </div>

        <!-- Timeline Progress Bars -->
        <div class="timelinea d-flex"></div>

        <!-- Story Content -->
        <div class="story-contentt" id="storyContent"></div>

        <!-- Navigation Icons -->
        <div class="navigation-icons">
            <div class="prev-iconn" id="prevIcon">&#10094;</div>
            <div class="next-iconn" id="nextIcon">&#10095;</div>
        </div>
    </div>
</div>

<!--Post Section-->

 <div class="pt-1 pb-3 px-2 mb-2 fw-semibold mt-4" id="uploadPostSection" >

    <div class="container mt-4">
      <div class="d-flex align-items-center">
        <img src="" alt="Profile" class="rounded-circle me-3" id="userProfileUploadSection" style="width: 40px; height: 40px; object-fit: cover;">
        <div class="pb-1" data-bs-toggle="modal" data-bs-target="#addPhotosVideosModal" id="addPhotosVideosModalInputdiv">
            <input class="form-control" placeholder="" id="addPhotosVideosModalInput"></input>
      </div>

    </div>
    <div class="d-flex justify-content-between text-center py-2 mt-3">
      <div class="d-flex align-items-center justify-content-center mb-3 mb-sm-0" style="cursor: pointer;">
          <i class="bi bi-camera-video-fill text-danger me-2 fs-5"></i>
          <span>Live video</span>
      </div>
      <div class="d-flex align-items-center justify-content-center mb-3 mb-sm-0" data-bs-toggle="modal" data-bs-target="#addPhotosVideosModal" style="cursor: pointer;">
          <i class="bi bi-image-fill text-success me-2 fs-5"></i>
          <span>Photo/video</span>
      </div>
       <div class="d-flex align-items-center justify-content-center" id="FeelingActivity" style="cursor: pointer;">
          <i class="bi bi-emoji-smile-fill text-warning me-2 fs-5"></i>
          <span>Feeling/activity</span>
      </div>
  </div>
  </div>
  </div>



<!--Post Modal-->
<div class="modal fade" id="addPhotosVideosModal" tabindex="-1" aria-labelledby="addPhotosVideosModalLabel"
  aria-hidden="true" >
  <div class="modal-dialog">
      <div class="modal-content">

        <form  id="postForm" enctype="multipart/form-data">
            {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title mx-auto" id="addPhotosVideosModalLabel">Create Post</h5>
            <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close" style="margin-left: 0px;"></button>
          </div>

          <div class="modal-body">

              <div class="d-flex align-items-center mb-3" style="margin-top:10px;">
                  <img src="{% static 'images/avatar.jpg' %}" alt="User Avatar"
                      class="user-avatar me-2">
                    <span class="fw-bold" style="color:white">{{ user.first_name }} {{ user.last_name }}</span>
              </div>
              <div class="mb-3  ">
                  <textarea class="form-control  " name="postTitle" placeholder="What do you want to talk about?" rows="2"
                      style="resize: none;background-color: #27236e"></textarea>
              </div>

              <div class="mb-3" >
                    <label for="fileInput" class="file-upload-label" style="width: 100%; outline:none; border:none">
                      <input type="file" name="postFiles" class="form-control d-none" id="fileInput" multiple>
                      <div
                          id="dropZone">
                          <p style="color:black;" class="select">Drag and drop photos or videos, or click to browse</p>
                          <i class="bi bi-image" style="color:black; font-size:22px;" class="inner"></i>
                      </div>
                  </label>

                <div class="con">
                </div>
            </div>


            <div class="pt-1 pb-3 px-2 mb-2 fw-semibold text-dark rounded" >
                <div class=" d-flex justify-content-between rounded p-2" style="border:1px solid black;align-items:center;background-color:white;" >

                    <span class="">Add to your post</span>

                    <div class="gap-3 d-flex md-icon ">
                    <i class="bi bi-images text-success" ></i>
                    <i class="bi bi-tag text-primary"></i>
                    <i class="bi bi-emoji-smile text-warning"></i>
                    <i class="bi bi-geo-alt-fill text-danger"></i>
                    <i class="bi bi-filetype-gif text-info"></i>
                </div>
                </div>

            </div>
          </div>
          <div class="justify-content-center mx-auto mb-3">
              <button type="submit" id="postForm'" id="load-more" class="btn text-dark  mx-auto b_btn px-3 d-flex" style="background-color:white;">Post</button>
          </div>
        </form>
      </div>
  </div>
</div>
</div>

<div class="py-3 mt-2 mb-5" id="homePagePostsection">





    {% if post_dict.posts %}
    {% for post in post_dict.posts %}
        <div class="container post-center pb-3 mb-3">
            <div class="post-box">
                <input type="hidden" class="firstPostId" name="firstPostId" value="{{post.id}}">
                <input type="hidden" class="firstUserId" name="firstUserId" value="{{post.posted_by_id}}">

                {% if post.posted_by.id == userid %}
                <div class="post-top" style="height: 45px;" onclick="window.location.href='{% url 'userprofile' %}'">
              {% else %}
                <div class="post-top" style="height: 45px;" onclick="window.location.href='{% url 'profile' post.posted_by.id %}'">
              {% endif %}
                  <a href="#">
                    <img src="{% static post.posted_by.profile_photo_url|default:'/images/avatar.jpg' %}"
                         class="rounded-circle me-1"
                         style="width: 35px; object-fit: cover; height: 35px;">
                  </a>
                  <div class="d-flex" style="flex-direction: column;">
                    <h6 class="u-name">
                      {{ post.posted_by.first_name }} {{ post.posted_by.last_name }}
                    </h6>
                    <span style="font-size:11px;margin-left: 15px;position: relative;bottom: 14px;" class="py-1">
                      {{ post.created_at|timesince }} ago <i class="bi bi-globe-americas p-1" style="font-size:10px"></i>
                    </span>
                  </div>
                </div>
              

                <div class="post-des-img">
                    <p class="px-3 pt-2" id="title" style="font-size:15px; margin: 0; margin-bottom: 5px;padding-bottom:13px;">
                        {{ post.title }}
                    </p>

                    {% if post.media_url|length == 1 %}
                        <div style="height:450px;">
                            {% if post.media_url.0|lower|slice:"-4:" == ".mp4" or post.media_url.0|lower|slice:"-5:" == ".webm" %}
                                <video controls class="img-fluid" style="height:100%;width:100%;object-fit:cover;">
                                    <source src="{% static post.media_url.0 %}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% else %}
                                <img src="{% static post.media_url.0 %}" class="img-fluid" alt="Post Image"
                                     style="height:100%;width:100%;object-fit:cover;">
                            {% endif %}
                        </div>
                    {% elif post.media_url|length > 1 %}
                        <div id="carouselExampleIndicators{{ post.id }}" class="carousel slide">
                            <div class="carousel-indicators">
                                {% for media in post.media_url %}
                                    <button type="button" data-bs-target="#carouselExampleIndicators{{ post.id }}"
                                            data-bs-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %}active{% endif %}"
                                            aria-current="{% if forloop.first %}true{% endif %}"
                                            aria-label="Slide {{ forloop.counter }}" style="display:none">
                                    </button>
                                {% endfor %}
                            </div>

                            <div class="carousel-inner">
                                {% for media in post.media_url %}
                                    <div class="carousel-item {% if forloop.first %}active{% endif %}" style="height:450px;width:100% !important;">
                                        {% if media|lower|slice:"-4:" == ".mp4" or media|lower|slice:"-5:" == ".webm" %}
                                            <video controls class="d-block" height="350" width="100%"style="object-fit:cover;"  >
                                                <source src="{% static media %}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                        {% else %}
                                            <img src="{% static media %}" class="d-block" height="350" width="100%"
                                                 alt="Slide {{ forloop.counter }}">
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>

                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators{{ post.id }}" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators{{ post.id }}" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    {% endif %}
                </div>

                <div>
                    <div class="d-flex align-items-center px-2">
                        <i class="bi bi-hand-thumbs-up pe-1 emojis_hide" style="font-size:12px"></i>
                        <i class="bi bi-heart emojis_hide" style="font-size:12px"></i>
                        <span style="font-size:14px;color:#e9e6e6c7;margin-left: 5px;margin-bottom: 2px;" id="reaction-count">
                            <span style="font-size:14px;color:#e9e6e6c7;margin-left: 5px;" class="px-2" id="total-reaction-count"></span>
                        </span>
                        <span style="font-size:14px;color:#e9e6e6c7;" class="ms-auto pe-2 commentcountshow">
                            <span id="total-comment-count"></span> comments
                        </span>
                    </div>
                </div>

                <div class="post-react-det">
                    <div class="post-react" style="cursor: pointer;">
                        <div class="reaction-container" style="position: relative; display: inline-block;">
                            <input type="hidden" class="getemoji">
                            <span class="post_reaction" style="cursor: pointer;">
                                <i class="bi bi-heart pe-1" style="font-size: 18px; cursor: pointer;position: relative;top: 6px;"></i>
                            </span>

                            <div class="reaction-popover" style="display: none; position: absolute; top: -50px; left: 0; background:black; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);">
                                <i data-reaction-id="1" class="fa-solid fa-heart" style="color: #ff0000;font-size: 20px;cursor: pointer;"></i>
                                <i data-reaction-id="2" class="fa-solid fa-face-laugh-squint" style="color: #ffcb0f;font-size: 20px;cursor: pointer;"></i>
                                <i data-reaction-id="3" class="fa-solid fa-face-smile-beam" style="color: #FFD43B;font-size: 20px;cursor: pointer;"></i>
                                <i data-reaction-id="4" class="fa-solid fa-face-angry" style="color: #ff0a0a;font-size: 20px;cursor: pointer;"></i>
                            </div>
                        </div>
                        <input type="hidden" id="user_id" value="{{ request.user.id }}">
                        <input type="hidden" id="post_id" value="{{ post.id }}">
                        <span data-toggle="modal" class="load-comments"><i class="fa-regular fa-comment"></i></span>
                        <i class="fa-solid fa-share-nodes share-post-btn" data-post-id="{{ post.id }}" data-bs-toggle="modal" data-bs-target="#shareModal"></i>

                        {% if post.posted_by_id == userid %}
                            <span data-bs-toggle="modal" class="editmodal"><i class="fa-solid fa-pen post-pe-icon"></i></span>
                            <i class="fa-solid fa-trash post-pe-icon" id="deletePostBtn"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endif %}


<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal fade" tabindex="-1" role="dialog" >
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content shadow-lg"  style="background-color:#1f0447fb;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-light">Confirm Deletion</h5>
                <button type="button" class="close text-muted" data-dismiss="modal" aria-label="Close">
                    {% comment %} <span aria-hidden="true">&times;</span> {% endcomment %}
                </button>
            </div>
            <div class="modal-body text-center">
                <p class="text-light">Are you sure you want to delete this post?</p>
            </div>
            <div class="modal-footer border-0 d-flex justify-content-center">
                <button type="button"  class="btn  px-4 py-2 " id="cancelDeleteBtn" style="background-color: rgb(94, 94, 94);color:white">Cancel</button>
                <button type="button" class="btn  px-4 py-2" id="confirmDeleteBtn" style="background-color:#ea4545;color:white;">Yes, Delete</button>
            </div>
        </div>
    </div>

</div>


<!--Edit Modal -->
<div class="modal fade" id="editpostModal" tabindex="-1" aria-labelledby="editpostModalLabel" aria-hidden="true" >
    <div class="modal-dialog">
        <input type="hidden"  id="p_id" style="color:black;">
        <input type="hidden"  id="p_user" style="color:black;">

        <form  id="editForm"  class="mt-3">
            {% csrf_token %}



        <div class="modal-content   " style="background-color:#2f066de3;" >
             <div class="modal-header" >
                <h5 class="modal-title mx-auto" id="editpostModalLabel">Edit Post</h5>
                <button type="button" class="btn-close ml-5" data-bs-dismiss="modal" aria-label="Close" style="margin-left:0px;"></button>
            </div>
            <div class="modal-body" >
            <div class="d-flex align-items-center mb-3" style="margin-top:10px;" id="update_userpost">

                {% comment %} <img src="{% static 'images/avatar.jpg' %}" alt="User Avatar"
                        class="user-avatar me-2">
                    <span class="fw-bold text-light">Priya Mitra</span>{% endcomment %}
                </div>
                <div class="mb-3  " id="updatepost">

               </div>
               </div>
               </div>
        </form>
    </div>
    </div>


{% comment %} Here work by Badhan {% endcomment %}
<div id="carouselExampleForShortSection" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      {% for video in shorts %}
      <div class="carouselItemForShortSection {% if forloop.first %}active{% endif %}" id="videoBox{{ forloop.counter }}">
        <a href="{% url 'short' %}?post_id={{ video.id }}" id="videoLink{{ forloop.counter }}">
          <div class="video-wrapper" id="video{{ video.id }}" data-post-id="{{ video.id }}">
            <div class="video-box">
              {% if video.media_url %}
              <video id="myVideo{{ forloop.counter }}" autoplay loop muted>
                <source src="{% static video.media_url.0 %}" type="video/mp4">
              </video>
              {% else %}
              <p>No video available.</p>
              {% endif %}
            </div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
    <!-- Carousel Controls -->
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

<style>
    #carouselExampleForShortSection {
        max-width: 100%;
        margin: 10px auto;
        overflow-x: hidden; /* Hide horizontal overflow */
    }
    .carousel-inner {
        display: flex;
        flex-wrap: nowrap; /* Prevent wrapping */
        justify-content: flex-start; /* Align items to the start */
        margin-left:10px;
        gap: 5px;
    }
    .carouselItemForShortSection {
        flex: 0 0 auto;
        width: 100%;
        max-width: calc(100% / 3 - 20px); /* Default to 3 videos per row */
        margin: 5px;
        box-sizing: border-box;
        transition: transform 0.5s ease;
    }
    .carouselItemForShortSection video {
        width: 100%;
        height: auto;
        margin:auto;
        aspect-ratio: 9/16; /* Aspect ratio for vertical videos */
        object-fit: cover;
        border-radius: 10px;
    }
    @media (max-width: 768px) {
        .carouselItemForShortSection {
            max-width: calc(100% / 2 - 20px); /* Adjust to 2 videos per row for smaller screens */
        }
    }

</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const carousel = document.getElementById('carouselExample');
        const prevButton = carousel.querySelector('.carousel-control-prev');
        const nextButton = carousel.querySelector('.carousel-control-next');
        const items = carousel.querySelectorAll('.carousel-item');
        let currentIndex = 0;
        const videosPerView = () => window.innerWidth < 768 ? 2 : 3;

        function showItems() {
            const perView = videosPerView();
            items.forEach((item, index) => {
                item.style.display = (index >= currentIndex && index < currentIndex + perView) ? 'block' : 'none';
            });
            updateButtons();
        }

        function showNextItem() {
            if (currentIndex + videosPerView() < items.length) {
                currentIndex++;
            }
            showItems();
        }

        function showPrevItem() {
            if (currentIndex > 0) {
                currentIndex--;
            }
            showItems();
        }

        function updateButtons() {
            const isFirstItem = currentIndex === 0;
            const isLastItem = currentIndex + videosPerView() >= items.length;
            prevButton.style.display = isFirstItem ? 'none' : 'block';
            nextButton.style.display = isLastItem ? 'none' : 'block';
        }

        prevButton.addEventListener('click', showPrevItem);
        nextButton.addEventListener('click', showNextItem);
        window.addEventListener('resize', showItems);

        showItems();
        updateButtons();
    });

</script>

{% comment %} End by Badhan {% endcomment %}




<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-purple text-light">
        <div class="modal-header">
          <h5 class="modal-title mx-auto" id="shareModalLabel">Share Post</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Hidden input for post id -->
          <input type="hidden" id="sharePostId" value="">
          <!-- Search input -->
          <input type="text" class="form-control mb-3" id="shareModalInput" placeholder="Type a name">
          <!-- Container to load profile items dynamically -->
          <div id="profileContainer">
            <!-- Dynamic profiles will be injected here -->
          </div>
          <!-- Social icons for sharing -->
          <div class="share-social-icons d-flex justify-content-around my-3">
            <div class="icon whatsapp"><i class="fab fa-whatsapp"></i></div>
            <div class="icon facebook"><i class="fab fa-facebook-f"></i></div>
            <div class="icon twitter"><i class="fab fa-twitter"></i></div>
            <div class="icon linkedin"><i class="fab fa-linkedin-in"></i></div>
            <div class="icon instagram"><i class="fab fa-instagram"></i></div>
            <div class="icon link"><i class="fas fa-link"></i></div>
          </div>
          <!-- Share button container: hidden until at least one profile is selected -->
          <div class="share-button-container" id="shareButtonContainer" style="display: none;">
            <button class="btn btn-primary" id="sendShareButton">
              <i class="bi bi-send-fill"></i> Share
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  

<script>

    $(document).on("click", ".share-post-btn", function () {
        // Read the post id from the data attribute
        let postId = $(this).data("post-id");
        // Set the hidden input value so it's available for later logic
        $("#sharePostId").val(postId);
        // Optionally, update your share modal content based on this post id
        updateShareResults(postId);
        // Show the modal (if not already triggered by data attributes)
        $("#shareModal").modal("show");
      });
      

const senderId = "{{ user.id }}"; // Rendered from your template
const staticUrl = "{% static '' %}"; // This usually returns "/static/"

function cleanMediaPath(media) {
  return media.startsWith('/') ? media.slice(1) : media;
}

// Global variable to store the current post id
let currentPostId = null;

// Function to update the share results (chats and profiles) via AJAX
function updateShareResults(postId) {
  const $container = $("#profileContainer");
  // Fade out container to indicate loading
  $container.fadeTo(100, 0.5);

  // Get current search query
  const searchQuery = $("#shareModalInput").val();

  // AJAX call to fetch chats and profiles
  $.ajax({
    url: '/post/share/api',
    type: 'GET',
    data: { post_id: postId, search: searchQuery },
    dataType: 'json',
    success: function (data) {
      console.log("AJAX data:", data);
      let html = '';
      const fallbackImage = "/images/avatar.jpg";

      // Render Chats Section
      if (data.chats && data.chats.length > 0) {
        html += `<div class="section chats-section"><h6>Chats</h6>`;
        data.chats.forEach(chat => {
          const chatImage = chat.chat_cover ? chat.chat_cover : fallbackImage;
          const chatBio = chat.bio ? chat.bio : "No bio available";
          html += `
            <div class="profile-item">
              <img src="${staticUrl}${cleanMediaPath(chatImage)}" alt="Chat Cover" class="profile-pic">
              <div>
                <strong>${chat.title}</strong><br>
                <small>${chatBio}</small>
              </div>
              <div class="custom-checkbox">
                <input type="checkbox" class="share-checkbox" id="chat-${chat.id}" onclick="toggleShareButton()">
              </div>
            </div>
          `;
        });
        html += `</div>`;
      }

      // Render Follower & Following Section
      if (data.follow && data.follow.members && data.follow.members.length > 0) {
        html += `<div class="section members-section"><h6>follower &amp; following</h6>`;
        data.follow.members.forEach(member => {
          const profilePhoto = member.user_id__profile_photo_url ? member.user_id__profile_photo_url : fallbackImage;
          const bioText = member.user_id__bio ? member.user_id__bio : "No bio available";
          html += `
            <div class="profile-item">
              <img src="${staticUrl}${cleanMediaPath(profilePhoto)}" alt="Profile Picture" class="profile-pic">
              <div>
                <strong>${member.user_id__first_name} ${member.user_id__last_name}</strong><br>
                <small>${bioText}</small>
              </div>
              <div class="custom-checkbox">
                <input type="checkbox" class="share-checkbox" id="profile-${member.user_id}" onclick="toggleShareButton()">
              </div>
            </div>
          `;
        });
        html += `</div>`;
      }

      // If nothing is available, show a message
      if (!html.trim()) {
        html = "<p>No chats or profiles found.</p>";
      }

      // Update the container with new content and restore opacity
      $container.html(html).fadeTo(100, 1);
      // Reset share button state based on checkboxes
      toggleShareButton();
    },
    error: function () {
      $container.html("<p>Error loading profiles.</p>").fadeTo(100, 1);
    }
  });
}

// Utility function to toggle the share button based on checkbox selections
function toggleShareButton() {
  const checkboxes = document.querySelectorAll('.share-checkbox');
  const isAnyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
  document.getElementById("shareButtonContainer").style.display = isAnyChecked ? "block" : "none";
}

// Function to send share data to a specific chat via WebSocket
const sendShareToChat = (chatId, postId, senderId) => {
  const ws = new WebSocket(`ws://${window.location.host}/ws/chat/`);

  ws.onopen = () => {
    // Join the chat group first
    ws.send(JSON.stringify({
      action: 'join',
      chat_id: chatId,
    }));

    // After a brief delay, send the create request
    setTimeout(() => {
      ws.send(JSON.stringify({
        chat_id: chatId,
        sender_id: senderId,
        post_id: postId,
        action: 'create',
      }));
      // Optionally close the connection after sending
      ws.close();
    }, 200);
  };

  ws.onerror = (error) => {
    console.error(`WebSocket error for chatId ${chatId}:`, error);
  };

  ws.onclose = (e) => {
    console.log(`WebSocket connection for chatId ${chatId} closed:`, e);
  };
};

$(document).ready(function () {
  // Optionally initialize currentPostId from the hidden input if it has a value
  currentPostId = $("#sharePostId").val();
  updateShareResults(currentPostId);

  // When the search input changes, update the profile list using the current post id
  $("#shareModalInput").on("input", function () {
    let postIdForSearch = $("#sharePostId").val() || currentPostId;
    updateShareResults(postIdForSearch);
  });

  // When a share button on a post is clicked,
  // Ensure your share buttons have the class 'share-post-btn' and a data attribute 'data-post-id'
  $(document).on("click", ".share-post-btn", function () {
    let buttonPostId = $(this).data("post-id");
    console.log("Share button clicked, post id from data attribute:", buttonPostId);
    currentPostId = buttonPostId;
    $("#sharePostId").val(currentPostId);
    updateShareResults(currentPostId);
    $("#shareModal").modal("show");
  });

  // When the send share button is clicked, use the global currentPostId
  $("#sendShareButton").on("click", function () {
    // Use currentPostId or the value from the hidden input as fallback
    const postIdForSend = currentPostId || $("#sharePostId").val();
    console.log("postID for sending:", postIdForSend);
    
    let selectedMembers = [];
    let selectedChats = [];

    // Iterate over each checked share-checkbox
    $(".share-checkbox:checked").each(function () {
      let idStr = $(this).attr("id");
      if (idStr.indexOf("profile-") === 0) {
        selectedMembers.push(idStr.replace("profile-", ""));
      } else if (idStr.indexOf("chat-") === 0) {
        selectedChats.push(idStr.replace("chat-", ""));
      }
    });

    if (selectedMembers.length === 0 && selectedChats.length === 0) {
      alert("Please select at least one profile or chat.");
      return;
    }

    // Send both selected chats and members via AJAX using the determined post id
    $.ajax({
      url: '/post/send',
      type: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      contentType: 'application/json',
      data: JSON.stringify({
        post_id: postIdForSend,
        chats: selectedChats,
        members: selectedMembers
      }),
      dataType: 'json',
      success: function (response) {
        if (response.chat && response.chat.length > 0) {
          response.chat.forEach((chatId) => {           
            console.log("Sending to chat with postID:", postIdForSend);
            sendShareToChat(chatId, postIdForSend, senderId);
          });
        }
        alert("Post shared successfully!");
        $("#shareModal").modal("hide");
      },
      error: function () {
        alert("Error sharing post.");
      }
    });
  });

  // Utility function to get a cookie by name (used for CSRF token)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});


</script>








{% comment %} comment modal by priya {% endcomment %}
<div  class="modal fade custom-modal" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">

    <div class="modal-dialog modal-dialog-centered "role="document" >

        <div class="modal-content d-flex comment-mod" >

           <span class="modal-header p-0">
             <button type="button" class="btn-close " data-bs-dismiss="modal" aria-label="Close" style="color:white;right:5px;top:5px;position:relative;"></button>
            </span>


     <div style="display: flex; " class="comment-div">
        <div class="col-md-6 ">


            <div class="post-top d-flex  px-1 pb-2" style="height: 45px;" id="proffile" >


           </div>


            <div class="post-center pb-3 CommentSectionPostImgDiv" style="margin-left: 0px;" id="photo_com">
                <p class="px-3 pt-2" style="font-size:15px; margin: 0; margin-bottom: 5px;" >wow cool</p>


                    <div class="post-box pb-2" >


                </div>
            </div>
        </div>


  <div class="" style="display:flex;flex-direction: column; justify-content:space-arround; ">

    <div class="comment-section " >

        <div class="CommentSectionEmptyDiv" style="height:50px;"> </div>
        <div class="comment-box p-1 com "id="comments-container"  style="height:500px; overflow-y: scroll;margin-left:20px;">

            <div class="pt-2 pe-2" style="height: auto;" class="comment" id="commentList"  id="autorefresh" id="commentsDiv">




            </div>

    </div>






    <input type="hidden"  id="postidd" style="color:black;">
    <input type="hidden"  id="useridd" style="color:black;">

   <form  id="commentForm" class="mt-3">
    {% csrf_token %}

    <div id="CommentsectionTextarea" class="container-fluid py-2 com_sent" style="position: absolute; bottom: 0; ">
        <div class="input-group ms-2">
            <!-- Left icons -->
            <div class="input-group-prepend d-flex gap-2 align-items-center pe-2">
                <i class="bi bi-emoji-smile text-light fs-6"></i>
            </div>

            <!-- Comment input -->
            <input
                class="form-control"
                id="commentText"
                name="comment_text"
                placeholder="Write a comment..."
                style="border-radius: 15px; background-color: #27236e; color: white;"
            >

            <!-- Right button -->
            <div class="input-group-append d-flex gap-3 align-items-center ps-2">
                <button id="createcomment" type="submit" class="btn btn-transparent text-info p-0">
                    <img src="{% static 'images/send-message.png' %}" alt="" style="height: 23px;">
                </button>
            </div>
        </div>
    </div>


  </form>
</div>
</div>

</div>

 </div>
</div>
  </div>

 </div>




 <script src="{% static 'js/sribash.js' %}"></script>
<script>

    const currentUserId = {{ userid }}; 

$(document).ready(function () {
    let holdTimer; // Track the hold time

    $(".post_reaction").on("mousedown touchstart", function (event) {
        event.preventDefault(); // Prevent unintended behavior on mobile
        let reactionButton = $(this);
        let postContainer = reactionButton.closest('.reaction-container');
        let postId = postContainer.closest('.post-box').find('.firstPostId').val();

        // Start a timer when the button is pressed or touched
        holdTimer = setTimeout(function () {
            deleteReaction(reactionButton, postId);
        }, 1000); // 1-second delay
    });

    $(".post_reaction").on("mouseup mouseleave touchend touchcancel", function () {
        clearTimeout(holdTimer); // Cancel timer if released before 1 second
    });

    function deleteReaction(button, postId) {
        $.ajax({
            url: "{% url 'delete_post_reaction' %}",  // Define this URL in Django
            type: "POST",
            data: {
                'post_id': postId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function (response) {
                if (response.success) {
                    button.find("i").removeClass().addClass("bi bi-heart").css({'color': '#a7358b', 'position': 'relative', 'top': '6px'}); // Reset icon
                    button.closest('.post-box').find("#total-reaction-count").text(response.total_count); // Update count

                    if (response.total_count === 0) {
                        button.closest('.reaction-container').find(".emojis_hide").hide(); // Hide if no reactions
                    }
                }
            },
            error: function () {
                alert('Error deleting reaction');
            }
        });
    }
});


$(document).ready(function() {
    // When the post_reaction is clicked, show the popover
    $('.post_reaction').click(function () {
        $(this).siblings('.reaction-popover').toggle();
    });

    // When a reaction icon is clicked, update the span and send AJAX request
    $('.reaction-popover i').click(function () {
        var reactionId = $(this).data('reaction-id');
        var postContainer = $(this).closest('.reaction-container');
        var FirstPostId = $(this).closest('.post-box').find('.firstPostId').val();
        var selectedIcon = $(this).attr('class');  // Get the class of selected icon
        var selectedColor = $(this).css('color'); // Get the color of selected reaction

        // Update the main reaction span with selected icon
        postContainer.find('.post_reaction i')
            .attr('class', selectedIcon)  // Change the icon class
            .css('color', selectedColor)// Apply the selected color
            .css('top', 0);


        // Hide the popover after selection
        postContainer.find('.reaction-popover').hide();

        // Send AJAX request to update reaction
        $.ajax({
            url: "{% url 'update_post_reaction' %}",
            type: "POST",
            data: {
                'post_id': FirstPostId,
                'reaction_id': reactionId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function (response) {
                console.log(response);

                var totalReactions = response.total_count; // Total reactions
                var reactionNames = response.reaction_name; // List of user names
                var userReactionId = response.user_reaction_id; // User's reaction ID

                // Update reaction count text dynamically
                var reactionText = "";
                if (reactionNames.length > 0) {
                    if (reactionNames.length === 1) {
                        reactionText = `${reactionNames[0]}`;
                    } else if (reactionNames.length === 2) {
                        reactionText = `${reactionNames[0]} and ${reactionNames[1]}`;
                    } else {
                        reactionText = `${reactionNames[0]}, ${reactionNames[1]} and ${totalReactions - 2} others`;
                    }
                }

                // Update total reaction count
                postContainer.closest('.post-box').find("#total-reaction-count").text(totalReactions);

                // Update reaction names display
                postContainer.closest('.post-box').find("#reaction-count").html(reactionText);

                // Hide the reaction container if no reactions
                if (parseInt(totalReactions) === 0) {
                    postContainer.find(".emojis_hide").hide();
                } else {
                    postContainer.find(".emojis_hide").show();
                }
            },
            error: function () {
                alert('Error updating reaction');
            }
        });
    });
});

// get reaction ajax
$(document).ready(function () {
    $(".post-box").each(function () {
        var postContainer = $(this);
        var postId = postContainer.find('.firstPostId').val();

        // First AJAX: Fetch reactions and set emoji
        $.ajax({
            url: "{% url 'get_post_reactions' %}",
            type: "GET",
            data: {
                'post_id': postId
            },
            success: function (response) {


                var userReactionId = response.user_reaction_id; // User's reaction ID
                postContainer.find('.getemoji').val(userReactionId);  // Set value

                 // Get reaction count and names
                var totalReactions = response.total_count;
                var reactionNames = response.reaction_name; // List of names
                var userReactionId = response.user_reaction_id; // User's reaction ID



                if (parseInt(totalReactions)==0){

                    postContainer.find(".emojis_hide").hide()
                }
                // Set the reaction ID in the hidden input box
                postContainer.find('.getemoji').val(userReactionId);

                var reactionText = "";

                if (reactionNames.length > 0) {
                    if (reactionNames.length === 1) {
                        reactionText = `${reactionNames[0]}`;
                    } else if (reactionNames.length === 2) {
                        reactionText = `${reactionNames[0]} and ${reactionNames[1]}`;
                    } else {
                        reactionText = `${reactionNames[0]}, ${reactionNames[1]} and ${totalReactions - 2} others`;
                    }
                }


                // Update the total reaction count
                postContainer.find("#total-reaction-count").text(totalReactions);

                // Update the reaction display with names
                postContainer.find("#reaction-count").html(reactionText);
                // Now fetch the emoji_id after setting it
                fetchEmojiDetails(postContainer, postId);
            },
            error: function () {

            }
        });
    });


    function fetchEmojiDetails(postContainer, postId) {
    var FirstUserId = postContainer.find('.firstUserId').val();
    var emoji_id = postContainer.find('.getemoji').val();

    // Prepare data object
    var requestData = {
        'post_id': postId,
        'user_id': FirstUserId
    };

    // Only add emoji_id if it's not null or empty
    if (emoji_id) {
        requestData['emoji_id'] = emoji_id;
    }

    $.ajax({
        url: '/fetch_reactions/',
        method: 'GET',
        data: requestData,  // Send only non-null values
        success: function(response) {
            if (response.react && response.react.length > 0) {
                var emojiHtml = response.react[0].value; // Get the emoji HTML like <i class="fa-solid fa-heart"></i>
                // Update the reaction span with the new emoji
                postContainer.find('.post_reaction').html(emojiHtml);
            }
        }
    });
}

});


// comment reply
    $(document).ready(function () {
        $(document).on('click', '.com-reply', function () {
              // Get the closest comment container
    const parentComment = $(this).closest('.comment_by');

    const replyForId = parentComment.find('input[id="com_by"]').val();
    const replyForName = parentComment.find('input[id="com_by_name"]').val();

    if (!replyForId || !replyForName) {
        console.error("Could not find comment ID or Name.");
        return;
    }

    // Set the hidden input values for reply
    $('#replyForId').val(replyForId);
    $('#replyForName').val(replyForName);

    // Prepend @username in the comment input without overwriting existing text
    let commentBox = $('#commentText');
    let currentText = commentBox.val().trim();
    let mentionText = `@${replyForName} `;

    // Ensure that the mention is only added once
    if (!currentText.includes(mentionText)) {
        commentBox.val(mentionText + currentText + " ");
    }


    // Set focus to the input box
    commentBox.focus();


        });

        $('#commentForm').on('submit', function (e) {
            e.preventDefault();

            const commentText = $('#commentText').val().trim();
            const FirstPostId = $('#postidd').val();
            let replyForId = $('#replyForId').val();

            $.ajax({
                type: 'POST',
                url: '{% url "reply_comment" %}',

                data: {
                    post_id: FirstPostId,
                    reply_text: commentText,
                    reply_for: replyForId,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                success: function (data) {


                    $('#commentText').val(''); // Clear textarea
                    const commentList = $('#commentList');
                    commentList.empty(); // Clear previous comments




                    if (data.comments.length > 0 ) {
                        data.comments.forEach(comment => {
                            if (comment.reply_for_id==null){
                            const profileImage = comment.comment_by__profile_photo_url ? comment.comment_by__profile_photo_url : '/images/avatar.jpg';

                            const commentItem = `
                         <div class="d-flex py-1 allcomments">
                                    <img src="static${profileImage}" alt="User" class="rounded-circle"
                                        style="width:35px; height:35px;object-fit: cover;">
                                    <div class="d-flex flex-column">

                                        <input type="hidden" class="comment-id" value="${ comment.id }">
                                        <div class="comment-text mb-0 ps-2 py-1 rounded px-3"
                                             style="background-color:#311e4ee3;width: 300px;">
                                            <span class="d-block fw-bold">${comment.comment_by__first_name} ${comment.comment_by__last_name}</span>
                                            <li class="list-group-item">
                                                <span style="font-size:13px">${comment.comment}</span>
                                            </li>
                                        </div>
                                        <div class="d-flex p-1 comment_by" style="gap:20px; margin-left: 17px;">
                                            <span style="font-size:11px;cursor:pointer;">${new Date(comment.created_at).toLocaleString([], { weekday: 'long' })} ${new Date(comment.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                            <div class="comment">
                                                <i class="bi bi-heart" data-comment-id="${comment.id}" style="cursor: pointer;"></i>
                                               <span class="like-count" style="color:white;font-size:10px; ${comment.react_count > 0 ? '' : 'display:none;'}">
                                                    ${comment.react_count}
                                                </span>
                                            </div>
                                          <input type="hidden" value="${comment.id}" id="com_by">
                                           <input type="hidden" value="${comment.comment_by__first_name}" id="com_by_name">

                                             <input type="hidden" id="replyForId" name="reply_for" >
                                            <span style="font-size:11px;cursor:pointer;" class="com-reply"  >Reply</span>


                                            </div>
                                    <span class="view-comment" style="cursor: pointer; font-size:14px;margin-left:12px;"
      data-comment-id="${comment.id}">
    View Reply
</span>
                                    </div>
                                </div>

                            `;


                            commentList.append(commentItem);
                        } });

            } else {
                commentList.append('<li class="list-group-item">No comments available.</li>');
            }



                },
                error: function (xhr) {
                    console.error("Error submitting comment:", xhr);
                },
            });
        });
    });



//  get all comments

   $(document).ready(function () {
        $('.load-comments').click(function () {
            const FirstPostId = $(this).closest('.post-box').find('.firstPostId').val();
            const FirstUserId = $(this).closest('.post-box').find('.firstUserId').val();





            $.ajax({
                url: 'comments/getComment/',
                type: 'GET',
                dataType: 'json',
                data: {
                    post_id: FirstPostId,
                    user_id: FirstUserId,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                  },
                success: function (data) {

                    console.log(data)
                    $(this).closest('.post-box').find("#total-comment-count").text(data.comment_count);


                     const postid= FirstPostId
                     const userid=FirstUserId
                     document.getElementById("postidd").value = postid;
                     document.getElementById("useridd").value = userid;
                    const commentList = $('#commentList');
                    const photo_com = $('#photo_com');
                    const com_profile=$('#proffile')

                    commentList.empty(); // Clear previous comments


data.user_details.forEach(com_del => {
    const profileImage = com_del.profile_photo_url ? com_del.profile_photo_url : '/images/avatar.jpg';
const com_prof=`


<a href="" class="mx-1">
                    <img src="/static${profileImage}" alt="avatar" class="rounded-circle me-2 " style="width: 35px; object-fit: cover; height: 35px; " >
                </a>

                <div class="d-flex "style="flex-direction: column;" >
                 <h6 class="u-name mx-1"style="font-size:14px">${com_del.first_name} ${com_del.last_name} </h6>
                 <span style="font-size:11px;margin-left:5px;position: relative;bottom: 10px;" class="py-1">${new Date(com_del.created_at).toLocaleString([],  { weekday: 'long' })} ${new Date(com_del.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}<i class="bi bi-globe-americas p-1" style="font-size:10px"></i></span>

                 </div>    `;
com_profile.html(com_prof);
    });



let uniqueId = `carousel${data.posts[0].id}_${Math.random().toString(36).substring(7)}`; // Ensure a unique ID

let postItem = `
    <div class="post-des-img">
        <p class="px-3 pt-2" style="font-size:15px; margin: 0; margin-bottom: 5px;">${data.posts[0].title}</p>

        <div class="post-box pb-2 px-2">
            ${
                data.posts[0].media_url.length > 1
                ?
                // Carousel for multiple media files (images and videos)
                `
                    <div id="${uniqueId}" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators">
                            ${data.posts[0].media_url.map((media, index) => `
                                <button type="button" data-bs-target="#${uniqueId}"
                                        data-bs-slide-to="${index}" class="${index === 0 ? 'active' : ''}"
                                        aria-current="${index === 0 ? 'true' : 'false'}"
                                        aria-label="Slide ${index + 1}" style="display:none;">
                                </button>
                            `).join('')}
                        </div>

                        <div class="carousel-inner">
                            ${data.posts[0].media_url.map((media, index) => `
                                <div class="carousel-item ${index === 0 ? 'active' : ''}" style="height:450px;width:100% !important;">
                                    ${media.toLowerCase().endsWith('.mp4') || media.toLowerCase().endsWith('.webm')
                                        ? `<video controls class="d-block w-100" style="height:100%;object-fit:cover;">
                                            <source src="static${media}" type="video/mp4">
                                            Your browser does not support the video tag.
                                           </video>`
                                        : `<img src="static${media}" class="d-block w-100" alt="Slide ${index + 1}" style="height:100%;object-fit:cover;">`
                                    }
                                </div>
                            `).join('')}
                        </div>

                        <button class="carousel-control-prev" type="button" data-bs-target="#${uniqueId}" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#${uniqueId}" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                `
                :
                // Single media file (image or video)
                `
                    <div style="height:450px;">
                        ${data.posts[0].media_url[0].toLowerCase().endsWith('.mp4') || data.posts[0].media_url[0].toLowerCase().endsWith('.webm')
                            ? `<video controls class="img-fluid" style="height:100%;width:100%;object-fit:cover;">
                                <source src="static${data.posts[0].media_url[0]}" type="video/mp4">
                                Your browser does not support the video tag.
                               </video>`
                            : `<img src="static${data.posts[0].media_url[0]}" class="img-fluid" alt="Post Image" style="height:100%;width:100%;object-fit:cover;">`
                        }
                    </div>
                `
            }
        </div>
    </div>
`;

// **Manually initialize Bootstrap carousel after adding it to the DOM**
setTimeout(() => {
    let carouselElement = document.getElementById(uniqueId);
    if (carouselElement) {
        new bootstrap.Carousel(carouselElement);
    }
}, 500); // Delay to ensure it's added to the DOM

photo_com.html(postItem);



                    if (data.comments.length > 0 ) {
                        data.comments.forEach(comment => {
                            const commentUserId = comment.comment_by__id || "";
                            const profileUrl = (parseInt(commentUserId) === parseInt(currentUserId))
                            ? "{% url 'userprofile' %}"
                            : "/profile/" + commentUserId + "/";

                            if (comment.reply_for_id==null){
                                const profileImage = comment.comment_by__profile_photo_url ? comment.comment_by__profile_photo_url : '/images/avatar.jpg'
                            const commentItem = `
                                <div class="d-flex py-1 allcomments">
                                    <img src="/static${profileImage}" alt="User" class="rounded-circle follow-redirect"
                                                style="width:35px; height:35px;object-fit: cover;" data-profile-url="${profileUrl}">
                                    <div class="d-flex flex-column">


                                        <input type="hidden" class="comment-id" value="${ comment.id }">
                                        <div class="comment-text mb-0 ps-2 py-1 rounded px-3"
                                             style="background-color:#311e4ee3;width: 300px;">
                                            <span class="d-block fw-bold follow-redirect" data-profile-url="${profileUrl}"> ${comment.comment_by__first_name} ${comment.comment_by__last_name} </span>
                                            <li class="list-group-item">
                                                <span style="font-size:13px">${comment.comment}</span>
                                            </li>
                                        </div>
                                        <div class="d-flex p-1 comment_by" style="gap:20px; margin-left: 17px;">
                                            <span style="font-size:11px;cursor:pointer;">${new Date(comment.created_at).toLocaleString([], { weekday: 'long' })} ${new Date(comment.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                            <div class="comment">
                                                <i class="bi bi-heart" data-comment-id="${comment.id}" style="cursor: pointer;"></i>
                                               <span class="like-count" style="color:white;font-size:10px; ${comment.react_count > 0 ? '' : 'display:none;'}">
                                                    ${comment.react_count}
                                                </span>
                                            </div>
                                          <input type="hidden" value="${comment.id}" id="com_by">
                                           <input type="hidden" value="${comment.comment_by__first_name}" id="com_by_name">

                                          <input type="hidden" id="replyForId" name="reply_for" >
                                            <span style="font-size:11px;cursor:pointer;" class="com-reply"  >Reply</span>


                                            </div>
                                    <span class="view-comment" style="cursor: pointer; font-size:14px;margin-left:12px;"
      data-comment-id="${comment.id}">
    View Reply
</span>
                                    </div>
                                </div>
                            `;
                            commentList.append(commentItem);
                     } });


                    } else {
                        commentList.append('<li class="list-group-item">No comments available.</li>');
                    }

                    $('#commentModal').modal('show');
                 }.bind(this),
                error: function (xhr, status, error) {
                    console.error('Error loading comments:', error);
                }
          });
        });
    });

    $(document).on("click", ".follow-redirect", function() {
        const url = $(this).data("profile-url");
        window.location.href = url;
    });
    
  // comment total_count

$(document).ready(function () {
        $(".post-box").each(function () {
            var postContainer = $(this);
            var postId = postContainer.find('.firstPostId').val();

            // Fetch reactions for each post
            $.ajax({
                url: "{% url 'get_comment_reactions' %}",
                type: "GET",
                data: { 'post_id': postId },
                success: function (response) {

                 if (parseInt(response.total_count) > 0){

                    postContainer.find("#total-comment-count").text(response.total_count);

                 }
                 else{
                    postContainer.find(".commentcountshow").hide()
                 }

                },
                error: function () {

                    console.log('Error fetching reactions');
                }
            });
        });
    });


//  view reply comment

// View reply comment
$(document).on('click', '.view-comment', function () {
    const commentId = $(this).data('comment-id'); // Get clicked parent comment ID
    let button = $(this); // Store reference to the clicked button

    if (!commentId) {
        console.error("Error: commentId is not received!");
        return;
    }

    let repliesContainer = $(`#replies-${commentId}`);

    if (repliesContainer.length > 0) {
        // Toggle visibility and update button text accordingly
        repliesContainer.slideToggle(function () {
            if ($(this).is(':visible')) {
                button.text('Hide Reply');
            } else {
                button.text('View Reply');
            }
        });
    } else {
        $.ajax({
            url: 'comments/getReplies/',
            type: 'GET',
            dataType: 'json',
            data: { comment_id: commentId },
            success: function (data) {
                console.log("af",data)
                if (data.replies.length > 0) {
                    let replyHtml = `<div id="replies-${commentId}" class="ms-4" style="display: none;">`;

                    data.replies.forEach(reply => {
                        profile_pic=reply.comment_by__profile_photo_url ? reply.comment_by__profile_photo_url : '/images/avatar.jpg'
                        replyHtml += `
                            <div class="d-flex py-1 allcomments">
                                <img src="static${profile_pic}" alt="User" class="rounded-circle" style="width:30px; height:30px;object-fit:cover;">
                                <div class="d-flex flex-column">
                                    <div class="comment-text mb-0 ps-2 py-1 rounded px-3" style="background-color:#311e4ee3;width: 250px;">
                                        <span class="d-block fw-bold">${reply.comment_by__first_name} ${reply.comment_by__last_name}</span>
                                        <span style="font-size:13px">${reply.comment}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    replyHtml += `</div>`;

                    // Remove existing replies before appending (prevents duplication)
                    $(`#replies-${commentId}`).remove();

                    // Append replies to the correct parent comment
                    button.parent().append(replyHtml);

                    // Show the replies with animation and change button text
                    $(`#replies-${commentId}`).slideDown();
                    button.text('Hide Reply');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading replies:', error);
            }
        });
    }
});

document.addEventListener("click", function (event) {
    if (event.target.classList.contains("bi-heart") || event.target.classList.contains("bi-heart-fill")) {
        const commentElement = event.target.closest(".comment");
        const commentId = event.target.dataset.commentId;
        const likeCountElement = commentElement.querySelector(".like-count");

        if (commentId) {
            toggleReaction(commentId, event.target, likeCountElement);
        }
    }
});

function toggleReaction(commentId, iconElement, likeCountElement) {
    console.log("Sending reaction toggle request...");

    fetch("/toggle_reaction/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ comment_id: commentId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "liked") {
            iconElement.classList.remove("bi-heart");
            iconElement.classList.add("bi-heart-fill");
            iconElement.style.color = "red";
        } else {
            iconElement.classList.remove("bi-heart-fill");
            iconElement.classList.add("bi-heart");
            iconElement.style.color = "";
        }

        if (likeCountElement) {
            likeCountElement.textContent = data.total_likes;
            likeCountElement.style.display = data.total_likes > 0 ? "inline" : "none";
        }
    })
    .catch(error => console.error("Error:", error));
}

function getCSRFToken() {
    const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    return tokenElement ? tokenElement.value : "";
}

document.addEventListener("DOMContentLoaded", function () {
    const modal = document.querySelector(".allcomments");

    if (modal) {
        modal.addEventListener("show.bs.modal", function () {
            console.log("Modal opened, loading comments...");
            loadCommentsLikes();
        });
    }

    document.body.addEventListener("click", function (event) {
        if (event.target.closest(".load-comments")) {
            console.log("Load comments clicked...");
            loadCommentsLikes();
        }
    });
});

function loadCommentsLikes() {
    const userIdElement = document.getElementById("user_id");
    const postIdElement = document.getElementById("post_id");

    if (!userIdElement || !postIdElement) {
        console.error("User ID or Post ID not found!");
        return;
    }

    const userId = userIdElement.value;
    const postId = postIdElement.value;

    fetch(`/get-comments-likes/${userId}/${postId}/`)
    .then(response => response.json())
    .then(data => {
        data.comments.forEach(comment => {
            const commentElement = document.querySelector(`[data-comment-id="${comment.id}"]`);
            if (commentElement) {
                const iconElement = commentElement;
                const likeCountElement = commentElement.closest(".comment").querySelector(".like-count");

                if (comment.liked) {
                    iconElement.classList.remove("bi-heart");
                    iconElement.classList.add("bi-heart-fill");
                    iconElement.style.color = "red";
                } else {
                    iconElement.classList.remove("bi-heart-fill");
                    iconElement.classList.add("bi-heart");
                    iconElement.style.color = "";
                }

                if (likeCountElement) {
                    likeCountElement.textContent = comment.react_count;
                    likeCountElement.style.display = comment.react_count > 0 ? "inline" : "none";
                }
            }
        });
    })
    .catch(error => console.error("Error fetching comments likes:", error));
}


</script>



{% comment %} post update ajax {% endcomment %}
   <script>


$(document).ready(function () {
    $('.editmodal').click(function () {
        const FirstPostId = $(this).closest('.post-box').find('.firstPostId').val();
        const FirstUserId = $(this).closest('.post-box').find('.firstUserId').val();
        const updatedTitle = $('#editTitle').val();
        $.ajax({
            url: 'post/update/',
            type: 'GET',
            dataType: 'json',
            data: {
                post_id: FirstPostId,
                user_id: FirstUserId,
                postTitle: updatedTitle,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function (data) {
                document.getElementById("p_id").value = FirstPostId;
                document.getElementById("p_user").value = FirstUserId;
                const Post_photo = $('#updatepost');
                const user_detail = $('#update_userpost');

                data.User_del.forEach(user => {
                    const profile_pic=user.profile_photo_url ? user.profile_photo_url : '/images/avatar.jpg';
                    user_detail.html(`
                        <img src="static${profile_pic}" alt="User Avatar" class="user-avatar me-2"style="object-fit:cover;">
                        <span class="fw-bold text-light">${user.first_name} ${user.last_name}</span>
                    `);
                });

                data.post_detail.forEach(post => {
                    let mediaContent = '';
                    if (post.media_url.length > 1) {
                        mediaContent = `
                            <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    ${post.media_url.map((media, index) => `
                                        <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                            ${media.endsWith('.mp4') || media.endsWith('.webm') ?
                                                `<video controls class="d-block w-100" style="height: 200px; object-fit: cover;">
                                                    <source src="static${media}" type="video/mp4">
                                                    Your browser does not support the video tag.
                                                </video>` :
                                                `<img src="static${media}" class="d-block w-100" alt="Responsive image" style="height: 200px; object-fit: cover;">`
                                            }
                                        </div>
                                    `).join('')}
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>`;
                    } else {
                        mediaContent = post.media_url.map(media => `
                            <div class="editpic rounded" style="width: 100%; outline:none;border:none">
                                ${media.endsWith('.mp4') || media.endsWith('.webm') ?
                                    `<video controls class="rounded" style="width: 100%; height: auto;">
                                        <source src="static${media}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>` :
                                    `<img src="static${media}" class="rounded">`
                                }
                                <span style="font-size:40px;">&times;</span>
                            </div>
                        `).join('');
                    }

                    const postContent = `
                        <textarea class="form-control text-light" placeholder="caption..." rows="2" id="editTitle"
                            style="outline:none;border:none;resize: none; background-color: #27236e">${post.title}</textarea>
                        </div>
                        <div class="mb-3">${mediaContent}</div>
                        <div class="pt-1 pb-1 px-2 mb-1 fw-semibold text-dark rounded align-items-center">
                            <div class="d-flex justify-content-between rounded p-2" style="border:1px solid black;align-items:center;box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;background-color:white;">
                                <span>Add to your post</span>
                                <div class="gap-3 d-flex md-icon">
                                    <i class="bi bi-images text-success"></i>
                                    <i class="bi bi-tag text-primary"></i>
                                    <i class="bi bi-emoji-smile text-warning"></i>
                                    <i class="bi bi-geo-alt-fill text-danger"></i>
                                    <i class="bi bi-filetype-gif text-info"></i>
                                </div>
                            </div>
                        </div>
                        <div class="justify-content-center mx-auto mb-3" style="display: flex;">
                            <button type="submit" id="updatePostBtn" class="btn text-dark mx-auto b_btn px-5" style="background-color:white">Post</button>
                        </div>
                    `;

                    Post_photo.html(postContent);
                });

                $('#editpostModal').modal('show');

                $('#updatePostBtn').click(function () {
                    const updatedTitle = $('#editTitle').val();
                    $.ajax({
                        type: 'POST',
                        url: '/post/update/',
                        dataType: 'json',
                        data: {
                            post_id: FirstPostId,
                            postTitle: updatedTitle,
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function (response) {


// Update post title in modal
                $('#editTitle').val(updatedTitle);

                // Find the corresponding post box and update title
                $('.post-box').each(function () {
                    const currentPostId = $(this).find('.firstPostId').val();
                    if (currentPostId == postid) {
                        $(this).find('#title').text(updatedTitle);
                    }
                });













                        },
                        error: function (xhr, status, error) {

                            console.error('Error updating title:', error);
                        }
                    });
                });
            },
            error: function (xhr, status, error) {
                console.error('Error updating post:', error);
            }
        });
    });
});


$(document).ready(function () {
    let holdTimer; // Timer variable
    let commentToDelete = null; // Store reference to the comment

    $(document).on("mousedown touchstart", ".allcomments", function (event) {
        event.preventDefault(); // Prevent unintended scrolling on mobile

        commentToDelete = $(this);  // Store reference to comment
        let commentId = commentToDelete.find(".comment-id").val(); // Get comment ID

        // Start the hold timer (0.5 seconds)
        holdTimer = setTimeout(function () {
            showDeleteConfirmation(commentId, commentToDelete);
        }, 500);
    });

    $(document).on("mouseup mouseleave touchend touchcancel", ".allcomments", function () {
        clearTimeout(holdTimer); // Cancel the hold timer if user releases early
    });

    function showDeleteConfirmation(commentId, commentElement) {
        // Create a modal dynamically
        let modalHtml = `
            <div id="deleteModal" class="delete-modal" style="padding: 20px; border-radius: 5px; text-align: center;">
                <div class="delete-modal-content" style="background-color:#1f0447fb;">
                    <p>Are you sure you want to delete this comment?</p>
                    <button id="confirmDelete" data-comment-id="${commentId}" style="background-color:red;">Confirm Delete</button>
                    <button id="cancelDelete" style="background-color:gray; margin: 10px; padding: 10px 15px; border: none; cursor: pointer;">Cancel</button>
                </div>
            </div>
        `;

        // Append to body and show modal
        $("body").append(modalHtml);
        $("#deleteModal").fadeIn(200);

        // Handle cancel button
        $("#cancelDelete").click(function () {
            $("#deleteModal").fadeOut(200, function () { $(this).remove(); });
        });

        // Handle confirm delete button
        $("#confirmDelete").click(function () {
            let id = $(this).data("comment-id");
            deleteComment(id, commentElement);
            $("#deleteModal").fadeOut(200, function () { $(this).remove(); }); // Remove modal
        });
    }

    function deleteComment(commentId, commentElement) {
        $.ajax({
            url: "/delete-comment/", // Change to your actual delete endpoint
            type: "POST",
            data: {
                comment_id: commentId,
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val() // CSRF token for security
            },
            success: function (response) {
                if (response.success) {
                    commentElement.fadeOut(300, function () { $(this).remove(); }); // Smooth fade-out effect
                } else {
                    alert("Failed to delete comment.");
                }
            },
            error: function () {
                alert("Error deleting comment.");
            }
        });
    }
});


</script>



{% comment %} post delete ajax {% endcomment %}
<script>

    $(document).on('click', '#deletePostBtn', function () {
        const postBox = $(this).closest('.post-box'); // Get closest post container
        const postId = postBox.find('.firstPostId').val(); // Extract post ID

        if (!postId) {
            console.error('Post ID not found');
            return;
        }

        // Show the modal
        $('#deleteConfirmModal').modal('show');

        // Handle confirm delete button
        $('#confirmDeleteBtn').off('click').on('click', function () {
            $.ajax({
                type: 'POST',
                url: '/post/delete/',
                dataType: 'json',
                data: {
                    post_id: postId,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                },
                success: function (response) {


                    // Fade out modal and post box
                    $('#deleteConfirmModal').modal('hide');
                    postBox.fadeOut(300, function () {
                        $(this).remove();
                    });
                },
                error: function (xhr) {
                    console.error('Error deleting post:', xhr.responseJSON.error);
                }
            });
        });

        // Handle cancel button click
        $('#cancelDeleteBtn').off('click').on('click', function () {
            $('#deleteConfirmModal').modal('hide');
        });
    });
</script>

{% comment %} user post create ajax {% endcomment %}
<script>
    $(document).ready(function() {
        $('#postForm').on('submit', function(e) {
            e.preventDefault();
            const FirstPostId = $('#postid').val();

            let formData = new FormData(this);

            $.ajax({
                url: "{% url 'userpost_create' %}",
                type: "POST",

                data: formData,
                processData: false,
                contentType: false,
                postid:FirstPostId,

                success: function(response) {
                    if (response.success) {

                    $('#addPhotosVideosModal').modal('hide');
                    $('#postForm')[0].reset();
                    location.reload();

                    }
                    //  else {
                    //     alert("Error: " + response.message);
                    // }
                },
                error: function(xhr, status, error) {
                    alert("AJAX error: " + error);
                }
            });
        });
    });
</script>






<style>
    @media (min-width: 950px) {
        #CommentsectionTextarea {
            width: 480px;
            margin: 0 auto; /* Center the container */
        }
    }
    @media (min-width: 768px) and (max-width: 952px) {
        #CommentsectionTextarea{
            width: 300px;
        }
    }
    .reaction-popover {
        display: none;
        position: absolute;
        top: -50px;
        left: 0;
        background:#1f0447fb;
        padding: 5px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        display: flex; /* Make it row-wise */
        gap: 10px; /* Adds spacing between emojis */
        z-index: 5000;
    }
    .emoji {
        font-size: 24px;
        cursor: pointer;
       transition: transform 0.2s;
    }
      .emoji:hover {
        transform: scale(1.2);
    }

    .allcomments {
    cursor:pointer;
    }

   .delete-modal {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;

   display: flex;
   align-items: center;
   justify-content: center;
   z-index: 10000;
}

.delete-modal-content {
   background: #2f066de3;;
   padding: 20px;
   border-radius: 5px;
   text-align: center;
}

.delete-modal-content button {
   margin: 10px;
   padding: 10px 15px;
   border: none;
   cursor: pointer;

}

#confirmDelete {

   color: white;
   margin: 10px;
   padding: 10px 15px;
   border: none;
   cursor: pointer;
}


#cancelDelete {

   color: white;
   margin: 10px;
   padding: 10px 15px;
   border: none;
   cursor: pointer;
}


.custom-modal .modal-dialog {
     max-width: 1000px;
}
.modal-image {
 object-fit: cover;
width: 100%;
}


</style>
{% comment %} For Sribash section {% endcomment %}
<script src="{% static 'js/sribash.js' %}"></script>
<script>
  function uploadStory(){
    console.log("Clicked");
    window.location.href="/uploadStory"
  }
</script>
 {% endblock %}


