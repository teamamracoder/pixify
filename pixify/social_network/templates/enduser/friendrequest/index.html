
{% extends "enduser/base.html" %}

{% block title %}Pixify-Message{% endblock %}

{% block content %}

{% load static %}
{% csrf_token %}
<div class="px-3 py-3 mt-3" style="height:100%;background-color: #1f0447e3; box-shadow: 0 4px 8px rgba(151, 95, 236, 0.5);font-family: serif;border-radius: 7px;" >
    
<form method="post">{% csrf_token %}</form>

<div class="fcontainer" style="height:100%;overflow-y:scroll;scrollbar-width:none;">
    <div class="user-list" id="usersList">
        {% comment %} <div class="user-card">
            <img src="https://cdn-icons-png.flaticon.com/128/201/201634.png" alt="User">
            <div class="user-info">
                <h4>Rima Das</h4>
                <p>Followed by priya</p>
            </div>
            <button class="follow-btn" id="followUser">Follow</button>
        </div>
        <div class="user-card">
            <img src=https://cdn-icons-png.flaticon.com/128/3284/3284735.png alt="User">
            <div class="user-info">
                <h4>Subhasis Barman</h4>
                <p>Followed by rima and + 33 more</p>
            </div>
            <button class="follow-btn">Follow</button>
        </div> {% endcomment %}

    </div>
</div>
</div>
{% comment %} <script>document.addEventListener("DOMContentLoaded", () => {
    const followButtons = document.querySelectorAll(".follow-btn");

    followButtons.forEach(button => {
        button.addEventListener("click", () => {
            window.open("followed.html", "_blank");
        });
    });
});
</script> {% endcomment %}

<script>
    $(document).ready(function () {
        get_recommendedUsers();

    });
    //To get all Users List of Friend Request Page
    function get_recommendedUsers() {
        $.ajax({
            url: "{% url 'allRecommendedUsers' %}",
            type: "GET",
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function (data) {
               console.log(data);
               let usersList = $("#usersList");
                usersList.empty();

                data.forEach(user => {
                    //for default profile photo
                    let profilePhoto = user.profile_photo_url ? user.profile_photo_url : "/images/avatar.jpg";
                    let followersText = user.followers_text || "No followers yet";
                    const profileUrl = "/profile/" + user.id + "/";
                    //append user card for users one by one
                    usersList.append(`
                        <div class="user-card" data-user-id="${user.id}">
                            <img src="/static${profilePhoto}" alt="User" class = "follow-redirect" data-profile-url="${profileUrl}">
                            <div class="user-info">
                                <h4 id="userName" class = "follow-redirect" data-profile-url="${profileUrl}" >${user.first_name} ${user.middle_name ? user.middle_name + " " : ""}${user.last_name}</h4>
                                <p>${followersText}</p>
                            </div>
                            <button class="follow-btn" id="followUser">Follow</button>
                        </div>
                    `);
                });
                //After clicking Follow Button call followUser Function to  To Insert Follower table and add Following
                $(".follow-btn").on("click", function () {
                    let following_id = $(this).closest(".user-card").data("user-id");
                    followUser(following_id, $(this));

                    msgTitle="New Follower";
                    // curreentUserName Declare in End User base.html
                        //if(curreentUserName){
                        //    msgBody=curreentUserName + "Started to Follow You !! ";
                        //}else{
                        //    msgBody="Started to Follow You !! ";
                        //}
                    msgBody="Started to Follow You !! ";
                    //call Firebase Push Notification
                    send_notification_to_following_user(following_id,msgTitle,msgBody)
                });
            }
        });
    }

    $(document).on("click", ".follow-redirect", function() {
        const url = $(this).data("profile-url");
        window.location.href = url;
    });
    

//After Click Follow Button To Insert Follower table and add Following
    function followUser(following_id, buttonElement) {
        $.ajax({
            url: "{% url 'followUser' %}",
            type: "POST",
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken() // CSRF protection
            },
            data: { following_id: following_id },
            success: function (response) {
               // console.log(response);
               buttonElement.text("Following").prop("disabled", true).css("background", "#2d0669");

            },
            error: function (xhr, status, error) {
                console.error("Error following user:", error);
            }
        });
    }
   //to get CSRF Token
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
//For Send Notification to following User Using Firebase Push Notification
    function send_notification_to_following_user(following_id,msgTitle,msgBody) {
        var data = {
            user_id: following_id,
            title: msgTitle,
            body: msgBody
        };

        $.ajax({
            url: '{% url "send_notification" %}',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    console.log("Notification sent successfully. ");
                } else {
                    console.error("Error sending notification:", response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX request failed:", error);
            }
        });
    }

</script>



{% endblock %}




