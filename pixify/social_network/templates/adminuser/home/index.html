{% extends "../base.html" %}

{% block title %}Post List{% endblock %}

{% block content %}
<style>
/* Prevent button hover from changing background */
.orders .users:hover a:hover, .users a:hover {
    background-color: #a8dfc0 !important;
    color: #155724 !important;
}

.orders:hover a:hover {
    background-color: #99ccff !important;
    color: #004085 !important;
}

/* Prevent button hover from changing background */
.posts:hover a:hover {
    background-color: #ffeb99 !important;
    color: #856404 !important;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<h1 class="text-center mt-5">Dashboard</h1>


<!-- ajax call for dropdown -->
<select name="dropdown" id="dropdown">
    <option value="null">Select Days</option>
    <option value="7">7 Days</option>
    <option value="30">30 Days</option>
    <option value="90">90 Days</option>
    <option value="180">180 Days</option>
    <option value="360">1 Year</option>
</select>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        let currentDate = new Date().toISOString(); // Get current date in ISO format
        let days = null; // Initially null to fetch all data from the beginning

        // Initial API call when the page loads (without filtering)
        get_admin_chart_data(currentDate, 360);
    });

        // Dropdown change event
        $("#dropdown").change(function () {
            let days = $(this).val(); // Get selected value from dropdown
            let currentDate = new Date().toISOString(); // Get current date
            get_admin_chart_data(currentDate, days); // Fetch data based on selected days
        });

        // Function to fetch data via AJAX
        function get_admin_chart_data(currentDate, days) {
            $.ajax({
                url: "/admin-dashboard/",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ days: days, current_date: currentDate }),
                headers: { "X-CSRFToken": getCSRFToken() }, // Ensure CSRF token is included
                success: function (response) {

                    // console.log("interval_data:", response.interval_data);
                    // console.log("Admin Count:", response.all_data.admin_count);

                    // Update HTML elements with received data
                    $("#countTotalUser").text(response.all_data.user_count);
                    $("#countTotalAdmin").text(response.all_data.admin_count);
                    $("#countTotalPost").text(response.all_data.post_count);
                    // barchart_data_for_user(response.all_data.user_count)

                    let user_data_list = [
                        response.interval_data,
                    ];

                    console.log(user_data_list);

                    let admit_data_list = [
                        response.piechart_data
                    ];
                    console.log(admit_data_list);


                    let post_data_list = [
                        response.linechart_data,
                    ];
                    console.log(post_data_list);

                    barchart_data_for_user(user_data_list,admit_data_list,post_data_list);

                },
                error: function (error) {
                    console.log("Error:", error);
                }
            });
        }
        // Function to get CSRF token from cookies
        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith("csrftoken=")) {
                        cookieValue = cookie.substring("csrftoken=".length, cookie.length);
                        break;
                    }
                }
            }
            return cookieValue;
        }
</script>
<div class="container py-5">
    <div class="row g-3 justify-content-center">

        <div class="col-md-4 justify-content-center">
            <div class="card shadow users" style="background-color: #d4edda;">
                <a href="{% url 'user_list' %}" class="btn btn-sm btn-outline-success border-0">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <h5 class="card-title text-dark">Users</h5>
                        <span class="fs-2 text-secondary"><i class="bi bi-person-circle"></i></span>
                    </div>
                    <div class="card-footer d-flex justify-content-between bg-white text-dark">
                        <span id="countTotalUser"></span>
                        <span class="fs-4">&gt;</span>
                    </div>
                </a>
            </div>
        </div>
        <div class="col-md-4 justify-content-center">
            <div class="card shadow orders" style="background-color: #cce5ff;">
                <a href="#" class="btn btn-sm btn-outline-secondary border-0">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <h5 class="card-title text-dark">Admins</h5>
                        <span class="fs-2 text-secondary"><i class="bi bi-person"></i></span>
                    </div>
                    <div class="card-footer d-flex justify-content-between bg-white text-dark">
                        <span id="countTotalAdmin"></span>
                        <span class="fs-4">&gt;</span>
                    </div>
                </a>
            </div>
        </div>
        <div class="col-md-4 justify-content-center">
            <div class="card shadow posts" style="background-color: #fff3cd;">
                <a href="{% url 'manage_post_list' %}" class="btn btn-sm btn-outline-secondary border-0">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <h5 class="card-title text-dark">Posts</h5>
                        <span class="fs-2 text-secondary"><i class="bi bi-image-fill"></i></span>
                    </div>
                    <div class="card-footer d-flex justify-content-between bg-white text-dark">
                        <span id="countTotalPost"></span>
                        <span class="fs-4">&gt;</span>
                    </div>
                </a>
            </div>
        </div>


    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chart Section -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chart.js Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            /* Ensures all charts have the same height */
        }

        .chart-container1 {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            /* Ensures all charts have the same height */
        }

        canvas {
            max-width: 100%;
            /* Ensures responsiveness */
            max-height: 120%;
        }
    </style>
</head>

<body>

    <div class="container g-5">
        <div class="row">
            <!-- Bar Chart -->
            <div class="col-md-4 chart-container1">
                <canvas id="barChart" style="height: 1000px;"></canvas>
            </div>

            <!-- Pie Chart -->
            <div class="col-md-4 chart-container">
                <canvas id="pieChart" style="height: 1000px;"></canvas>
            </div>

            <!-- Radar Chart -->
            <div class="col-md-4 chart-container">
                <canvas id="lineChart" style="height: 1000px;"></canvas>
            </div>
        </div>
    </div>

    <script>

var barChartInstance = null;
var pieChartInstance = null;
var lineChartInstance = null;

function barchart_data_for_user(user_data_list, admin_data_list,post_data_list) {
    console.log("User Data:", user_data_list);
    console.log("Admin Data:", admin_data_list);
    console.log("Post Data:", post_data_list);

    const barChartData = user_data_list[0].map(item => item.count_month_2intervel);
    const pieChartData = admin_data_list[0].map(item => item.admin_count);
    const lineChartData = post_data_list[0].map(item => item.post_count);


    // Get canvas contexts
    var barCtx = document.getElementById("barChart").getContext("2d");
    var pieCtx = document.getElementById("pieChart").getContext("2d");
    var lineCtx = document.getElementById("lineChart").getContext("2d");
    // Destroy previous instances if they exist
    if (barChartInstance !== null) {
        barChartInstance.destroy();
    }
    if (pieChartInstance !== null) {
        pieChartInstance.destroy();
    }
    if (lineChartInstance !== null) {
        lineChartInstance.destroy();
    }

    // Create Bar Chart
    barChartInstance = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Jan-Feb', 'Mar-Apr', 'May-Jun', 'Jul-Aug', 'Sep-Oct', 'Nov-Dec'],
            datasets: [{
                label: 'Users',
                data: barChartData,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(144, 238, 144, 0.5)',
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(144, 238, 144, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Create Pie Chart
    pieChartInstance = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: ['Jan-Mar', 'Apr-Jun', 'Jul-Sep', 'Oct-Dec'],  // 3-month labels
        datasets: [{
            data: pieChartData,
            backgroundColor: [
            'rgba(153, 102, 255, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(144, 238, 144, 0.5)',

                // 'rgba(75, 192, 192, 0.5)'
            ],
            borderColor: [
            'rgba(153, 102, 255, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                // 'rgba(75, 192, 192, 1)'
                'rgba(144, 238, 144, 1)',

            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});





// // Create Line Chart (Static Data)
lineChartInstance = new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: ['Jan','Feb', 'Mar','Apr', 'May','Jun', 'Jul','Aug', 'Sep','Oct', 'Nov','Dec'], // 2-month intervals
        datasets: [{
            label: 'Posts',
            data: lineChartData, // Adjusted values
            backgroundColor: 'rgba(54, 162, 235, 0.2)', // Light fill under the line
            borderColor: 'rgba(54, 162, 235, 1)', // Line color
            borderWidth: 2,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)', // Point color
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5, // Size of points
            fill: true, // Fill the area under the line
            tension: 0.4 // Smooth curves
        }]
    },
    options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
});



}

    </script>

</body>

</html>
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}